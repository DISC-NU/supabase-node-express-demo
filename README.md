# Supabase Auth Server

An Express.js server implementing Supabase authentication with PostgreSQL database integration.

## Features

- üîê User authentication with Supabase
- üìö PostgreSQL database integration
- üõ°Ô∏è Protected routes with middleware
- üîÑ Automatic user profile creation
- üîç Detailed error logging

## Prerequisites

- Node.js (v14 or higher)
- npm or yarn
- PostgreSQL database
- Supabase account and project

## Installation

1. Clone the repository:

```bash
git clone https://github.com/DISC-NU/supabase-node-express-demo.git
cd supabase-auth-server
```

2. Install dependencies:

```bash
npm install
```

3. Create a `.env` file in the root directory:

```env
PORT=3000
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
```

## Development

To start the development server:

```bash
npm run dev
```

The server will start on `http://localhost:3000`.

## Project Structure

```
src/
‚îú‚îÄ‚îÄ config/           # Configuration files
‚îÇ   ‚îî‚îÄ‚îÄ supabase.js   # Supabase client configuration
‚îú‚îÄ‚îÄ controllers/      # Route controllers
‚îÇ   ‚îú‚îÄ‚îÄ authController.js   # Authentication controller
‚îÇ   ‚îî‚îÄ‚îÄ userController.js   # User management controller
‚îú‚îÄ‚îÄ middleware/       # Express middleware
‚îÇ   ‚îî‚îÄ‚îÄ auth.js       # Authentication middleware
‚îú‚îÄ‚îÄ routes/          # API routes
‚îÇ   ‚îú‚îÄ‚îÄ authRoutes.js # Authentication routes
‚îÇ   ‚îî‚îÄ‚îÄ userRoutes.js # User management routes
‚îú‚îÄ‚îÄ app.js           # Express app setup
‚îî‚îÄ‚îÄ server.js        # Server entry point
```

## API Endpoints

### Authentication

- `POST /auth/signup` - Register a new user
- `POST /auth/signin` - Sign in a user
- `GET /auth/protected` - Protected route example

### User Management

- `GET /api/users` - Get all users (protected)
- `GET /api/users/:id` - Get user by ID (protected)

## Database Setup

The server uses PostgreSQL with Supabase. Required tables:

# Supabase Auth Server

[Previous sections remain the same...]

## Database Setup

Run these SQL commands in your Supabase SQL editor to set up the required table and triggers:

```sql
-- Drop existing table if needed
DROP TABLE IF EXISTS users;

-- Create users table
CREATE TABLE IF NOT EXISTS users (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  firstName text NOT NULL,
  lastName text NOT NULL,
  email text NOT NULL UNIQUE,
  bio text,
  major text NOT NULL,
  graduationYear integer NOT NULL,
  profilePicture text,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  auth_id UUID REFERENCES auth.users(id)
);

-- Create index for email lookups
CREATE INDEX users_email_idx ON users(email);

-- Set up RLS (Row Level Security)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Anyone can read user profiles"
  ON users
  FOR SELECT
  TO anon
  USING (true);

-- Create trigger function to automatically create user profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
    INSERT INTO public.users (
        "firstName",
        "lastName",
        email,
        major,
        "graduationYear",
        auth_id
    ) VALUES (
        'New',
        'User',
        NEW.email,
        'Undeclared',
        2025,
        NEW.id
    );
    RETURN NEW;
EXCEPTION WHEN others THEN
    RAISE NOTICE 'Error in trigger: %', SQLERRM;
    RETURN NEW;
END;
$$;

-- Create trigger
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_new_user();

-- Grant necessary permissions
GRANT ALL ON TABLE users TO postgres;
GRANT ALL ON TABLE users TO authenticated;
```

This SQL setup includes:

1. User table creation with all necessary fields
2. Email index for faster lookups
3. Row Level Security (RLS) setup
4. Policy for reading user profiles
5. Trigger for automatic user profile creation on signup
6. Necessary permissions

[Rest of README remains the same...]

## Environment Variables

- `PORT`: Server port (default: 3000)
- `SUPABASE_URL`: Your Supabase project URL
- `SUPABASE_ANON_KEY`: Your Supabase project's anonymous key

## Available Scripts

- `npm run start` - Start production server
- `npm run dev` - Start development server with nodemon

## Error Handling

The server includes comprehensive error handling:

- Authentication errors
- Database errors
- Validation errors
- Custom error middleware

## Security Features

- JWT token validation
- Protected routes
- SQL injection prevention
- Request validation
- Error sanitization

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## Testing

```bash
# Example API test using curl
curl -X POST http://localhost:3000/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "password": "password123"}'
```

## License

This project is licensed under the MIT License - see the LICENSE file for details
